### 数据库

### redis

### 分布式

### 负载均衡

#### 特点

- 高可用：当某个节点故障时，负载均衡器不会将用户请求转发到该节点上，从而保证所有服务持续可用；
- 伸缩性：可以很容易地添加移除节点。

#### 过程

1.  根据负载均衡算法得到应该将请求转发到哪个节点上；
2.  将请求进行转发

#### 算法

1.  轮询
    轮流发送给每个服务器，每个服务器的性能差不多的场景。
2.  加权轮询
    性能高的服务器权值更高。
3.  最少连接
    将请求发送给当前最少连接数的服务器上。
4.  加权最少连接
    性能高的服务器权值更高。
5.  随机
    每个服务器的性能差不多的场景
6.  IP Hash
    客户端 ip 求哈希值，并取模。保证同一 ip 转发到同一服务器，保持会话。

#### 转发实现

1.  HTTP 重定向
    将目的地址写入 http 重定向报文，返回 302，客户端会重新发送请求。
    缺点：两次请求，延迟高；HTTP 负载均衡处理能力有限
2.  DNS 域名解析（第一级负载均衡）
    dns 解析时根据算法返回服务器地址。
    缺点：修改 dns 缓存记录生效时间长
3.  反向代理
    利用反向代理服务器进行转发。
    缺点：反向代理服务器性能瓶颈。
4.  网络层
    获取网络数据包，修改请求数据包的目的 ip 地址，进行转发。
    缺点：负载均衡服务器性能瓶颈。
5.  链路层（最广泛的方式）
    获取源服务器 mac 地址，修改目的 mac 地址，进行转发。

#### 一致性 hash

为了避免服务器节点增加或减少时数据缓存失效的问题，采用一致性 hash 算法。

原理：

- 整个 hash 空间形成一个圆环，利用哈希算法根据服务器 ip 计算出节点位置， 顺时针排列。
- 数据进行哈希后，按照顺时针查询服务器节点。
- 节点的增减只会影响部分数据，有很好的容错性和可拓展性。

### session

#### 集群中 session

1.  sticky sessions
    一个用户的请求 session 保存在一个服务器上
2.  session replication
    服务器之间会进行 session 同步操作。
3.  session server
    session 会存储在单独的服务器或数据库，需要应用服务器进行存取 session。
