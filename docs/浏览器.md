<!-- TOC -->

- [浏览器](#浏览器)
  - [浏览器进程与线程](#浏览器进程与线程)
  - [浏览器渲染过程](#浏览器渲染过程)
  - [普通图层和复合图层](#普通图层和复合图层)

<!-- /TOC -->

# 浏览器

[参考资料](http://www.dailichun.com/2018/01/21/js_singlethread_eventloop.html)

## 浏览器进程与线程

浏览器是多进程。每个标签页或窗口相当于一个独立进程。

1.  **Browser 进程**：浏览器的主进程（负责协调、主控），只有一个。作用有
    - 负责浏览器界面显示，与用户交互。如前进，后退等
    - 负责各个页面的管理，创建和销毁其他进程
    - 将 Renderer 进程得到的内存中的 Bitmap，绘制到用户界面上
    - 网络资源的管理，下载等
2.  **第三方插件进程**：每种类型的插件对应一个进程。
3.  **GPU 进程**：最多一个，用于 3D 绘制等
4.  **浏览器渲染进程**（浏览器内核）（Renderer 进程，内部是多线程的）：默认每个 Tab 页面一个进程，互不影响。主要作用为页面渲染，脚本执行，事件处理等

浏览器内核（渲染进程）是多线程，在内核控制下各线程相互配合以保持同步，一个浏览器通常由以下常驻线程组成：

- **GUI 渲染线程**——渲染浏览器界面，解析 css、html，构建 dom 树，布局，绘制
- **JavaScript 引擎线程**——执行 js 脚本
- **定时触发器线程**——`setTimeout`和`setInterval`定时任务，防止 js 单线程阻塞影响计时。
- **事件触发线程**——控制事件循环，异步事件。
- **异步 http 请求线程**——XMLHttpRequest

**GUI 渲染线程 与 JavaScript 引擎线程互斥！**，因此 js 执行时会阻塞浏览器渲染。

**WebWorker**

WebWorker 只属于某个页面，不会和其他页面的 Render 进程（浏览器内核进程）共享。**WebWorker 只是属于 render 进程下的一个线程**。

**SharedWorker**

SharedWorker 是浏览器所有页面共享的，不能采用与 Worker 同样的方式实现，因为它不隶属于某个 Render 进程，可以为多个 Render 进程共享使用。**SharedWorker 由独立的进程管理** 。

## 浏览器渲染过程

[见例题](./例题.md)

1.  前期：
    - 浏览器输入 url，浏览器主进程接管，开一个下载线程
    - 进行 http 请求（略去 DNS 查询，IP 寻址等等操作），然后等待响应，获取内容
    - 将内容通过 RendererHost 接口转交给 Renderer 进程
2.  浏览器渲染流程开始
    - 解析 html 建立 dom 树
    - 解析 css 构建 render 树（将 CSS 代码解析成树形的数据结构，然后结合 DOM 合并成 render 树）
    - 布局 render 树（Layout/reflow），负责各元素尺寸、位置的计算
    - 绘制 render 树（paint），绘制页面像素信息
    - 浏览器会将各层的信息发送给 GPU，GPU 会将各层合成（composite），显示在屏幕上。

## 普通图层和复合图层

GPU 中，复合图层是**单独绘制**，互不影响。

普通文档流内可以理解为一个复合图层 ，包括 absolute 布局。

`硬件加速`可以声明一个新的复合图层。

方法：`translate3d`、`translateZ`

一个元素开启硬件加速后会变成复合图层，可以独立于普通文档流中，改动后可以避免整个页面重绘，提升性能
